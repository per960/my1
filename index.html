
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scheduled Video Playlist</title>
  <style>
    body { margin:0; font-family:Arial,Helvetica,sans-serif; background:#111; color:#eee; }
    #player-wrapper { position:relative; width:100%; height:100vh; }
    iframe { width:100%; height:100%; border:none; }
    #info { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6);
            padding:8px 12px; border-radius:4px; font-size:0.9rem; }
  </style>
</head>
<body>

<div id="player-wrapper">
  <iframe id="videoIframe" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  <div id="info">Loading schedule…</div>
</div>

<script>
/* --------------------------------------------------------------
   Simple Scheduler – reads playlist.json and swaps the <iframe> src
   -------------------------------------------------------------- */
(async function () {

  // ------- CONFIG ------------------------------------------------
  const PLAYLIST_URL = 'playlist.json';   // relative path or absolute URL
  const CHECK_INTERVAL_MS = 5_000;        // how often we look for changes
  // ----------------------------------------------------------------

  const iframe = document.getElementById('videoIframe');
  const info   = document.getElementById('info');

  // Helper: parse ISO‑8601 to a Date with *local* time (no timezone conversion)
  const parseDate = s => new Date(s);

  // Load JSON (CORS must be allowed if the file lives on another domain)
  let schedule = [];
  try {
    const resp = await fetch(PLAYLIST_URL);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    schedule = await resp.json();
    // Sort by start time just in case
    schedule.sort((a,b) => new Date(a.start) - new Date(b.start));
  } catch (e) {
    info.textContent = `❌ Could not load playlist: ${e.message}`;
    console.error(e);
    return;
  }

  // --------------------------------------------------------------
  // Find out which entry should be active *right now*
  // --------------------------------------------------------------
  function getActiveEntry(now) {
    // Iterate from the latest start time backwards – first match wins
    for (let i = schedule.length - 1; i >= 0; i--) {
      const entry = schedule[i];
      const start = parseDate(entry.start);
      const end   = parseDate(entry.end);
      if (now >= start && now < end) {
        return {entry, start, end};
      }
    }
    return null; // nothing scheduled for this moment
  }

  // --------------------------------------------------------------
  // Switch function – updates <iframe> src and UI
  // --------------------------------------------------------------
  function switchTo(entryInfo) {
    const {entry, start, end} = entryInfo;
    iframe.src = entry.url;
    const now = new Date();
    const remainingSec = Math.round((end - now) / 1000);
    info.textContent = `${entry.title} – ends in ${remainingSec}s`;
    console.log(`[${now.toLocaleTimeString()}] Playing: ${entry.title}`);
  }

  // --------------------------------------------------------------
  // Main loop – runs every CHECK_INTERVAL_MS
  // --------------------------------------------------------------
  let currentEntry = null; // keep track of what we are showing
  function tick() {
    const now = new Date();
    const active = getActiveEntry(now);

    if (!active) {
      // No schedule – show a default message / blank screen
      if (iframe.src !== '') iframe.src = '';
      info.textContent = `No video scheduled (${now.toLocaleTimeString()})`;
      currentEntry = null;
      return;
    }

    // If the active entry changed, switch!
    if (!currentEntry || currentEntry.entry !== active.entry) {
      currentEntry = active;
      switchTo(active);
    } else {
      // Same entry – just update the countdown
      const remainingSec = Math.round((active.end - now) / 1000);
      info.textContent = `${active.entry.title} – ends in ${remainingSec}s`;
    }
  }

  // Run first tick immediately, then keep polling
  tick();
  setInterval(tick, CHECK_INTERVAL_MS);

})();
</script>

</body>
</html>
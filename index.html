
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Playlist Scheduler</title>
  <style>
    body {font-family: Arial, sans-serif; background:#222; color:#eee; margin:0; display:flex; flex-direction:column; height:100vh;}
    #player {flex:1; display:flex; align-items:center; justify-content:center; background:#000;}
    video {max-width:100%; max-height:100%;}
    #info {padding:0.5rem; background:#111; text-align:center;}
  </style>
</head>
<body>

<div id="player">
  <video id="video" controls autoplay muted></video>
</div>

<div id="info">
  <strong id="title">Loading schedule…</strong> |
  <span id="time"></span>
</div>

<script>
/* --------------------------------------------------------------
   1️⃣  Utility helpers
   -------------------------------------------------------------- */
// Parse an ISO‑8601 string to a Date object (native works fine)
function parseISO(iso) { return new Date(iso); }

// Returns true if `now` is inside the [start, end) interval.
// If `end` is undefined → interval is open‑ended.
function inInterval(now, start, end) {
  return now >= start && (!end || now < end);
}

/* --------------------------------------------------------------
   2️⃣  Load schedule JSON
   -------------------------------------------------------------- */
let schedule = [];          // will hold the parsed and sorted entries
let currentIdx = -1;        // index of the entry currently playing

async function loadSchedule() {
  try {
    const resp = await fetch('schedule.json', {cache: "no-store"});
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const raw = await resp.json();

    // Convert strings → Date objects and keep a reference to original object
    schedule = raw.map(entry => ({
      title: entry.title,
      src:   entry.src,
      start: parseISO(entry.start),
      end:   entry.end ? parseISO(entry.end) : undefined,
      raw: entry
    })).sort((a, b) => a.start - b.start);   // chronological order

    console.log('Schedule loaded:', schedule);
  } catch (e) {
    console.error('Could not load schedule:', e);
    document.getElementById('title').textContent = '❌ Schedule error';
  }
}

/* --------------------------------------------------------------
   3️⃣  Core scheduler logic
   -------------------------------------------------------------- */
const videoEl = document.getElementById('video');
const titleEl = document.getElementById('title');
const timeEl  = document.getElementById('time');

/**
 * Find the schedule entry that should be active right now.
 * Returns its **index** in the `schedule` array, or -1 if none.
 */
function findCurrentIndex(now) {
  for (let i = 0; i < schedule.length; i++) {
    const e = schedule[i];
    if (inInterval(now, e.start, e.end)) return i;
  }
  return -1;
}

/** Load a video entry into the <video> element */
function loadEntry(entry) {
  if (!entry) return;
  videoEl.src = entry.src;
  videoEl.load();               // forces reload of src
  titleEl.textContent = entry.title;
  // Autoplay (muted is required for autoplay on most browsers)
  videoEl.play().catch(err => console.warn('Autoplay blocked', err));
}

/** Main loop – checks every second */
function tick() {
  const now = new Date();
  timeEl.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});

  const idx = findCurrentIndex(now);
  if (idx !== currentIdx) {
    // Schedule changed → swap video
    if (idx >= 0) {
      console.log(`Switching to entry #${idx} – ${schedule[idx].title}`);
      loadEntry(schedule[idx]);
    } else {
      console.log('No entry for the current time – pausing');
      videoEl.pause();
      videoEl.removeAttribute('src');
      titleEl.textContent = 'No video scheduled';
    }
    currentIdx = idx;
  }
}

/* --------------------------------------------------------------
   4️⃣  Kick‑off
   -------------------------------------------------------------- */
(async function init() {
  await loadSchedule();
  // Run the ticker immediately and then each second
  tick();
  setInterval(tick, 1000);
})();
</script>

</body>
</html>